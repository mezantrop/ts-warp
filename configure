#!/bin/sh

# Copyright (c) 2024-2026, Mikhail Zakharov <zmey20000@yahoo.com>
#
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions are met:
#
# 1. Redistributions of source code must retain the above copyright notice, this
#    list of conditions and the following disclaimer.
#
# 2. Redistributions in binary form must reproduce the above copyright notice,
#    this list of conditions and the following disclaimer in the documentation
#    and/or other materials provided with the distribution.
#
# THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
# AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE ARE
# DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT HOLDER OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS OR
# SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION) HOWEVER
# CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY,
# OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE
# OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.

# ---------------------------------------------------------------------------- #
# Minmiconf (https://github.com/mezantrop/minmiconf) based configure script    #
# Note, it is NOT compatible with autotools one!                               #
# ---------------------------------------------------------------------------- #

# ---------------------------------------------------------------------------- #
. ./minmiconf
# ---------------------------------------------------------------------------- #

_DEBUG=N

# ---------------------------------------------------------------------------- #
CC_CANDIDATES="clang gcc cc"
PREFIX_CANDIDATES="$PREFIX /usr/local /opt $HOME"

EHARD;  DECIDE CONFIG_START     "STATE"    .configured

EHARD;  DECIDE DETECT_TARGET    "TARGET"
EHARD;  DECIDE DETECT_PREFIX    "PREFIX"    '"$PREFIX_CANDIDATES"'

EHARD;  DECIDE DETECT_CC         "CC"        '"$CC_CANDIDATES"'
IN_VAR "TARGET" "Darwin" "Y" && ! IN_VAR "CC" "gcc" && {
    EHARD;  DECIDE DETECT_COMMAND   "XCRUN" "xcrun"
    EHARD;  DECIDE DETECT_PATH  "MACOS_SDK_PATH"            "$(xcrun --show-sdk-path 2>/dev/null)"
            DECIDE DEFINE_VAR   "MACOS_SDK_INCLUDE_PATH"    "$MACOS_SDK_PATH/usr/include"
            DECIDE DEFINE_VAR   "MACOS_SDK_LIB_PATH"        "$MACOS_SDK_PATH/usr/lib"
}
INCLUDE_PATH_CANDIDATES="/usr/include $PREFIX/include $MACOS_SDK_INCLUDE_PATH"
LIB_PATH_CANDIDATES="/lib /usr/lib /usr/lib32 $PREFIX/lib $MACOS_SDK_LIB_PATH"
WITH_TCP_NODELAY=${WITH_TCP_NODELAY-1}
ESOFT;  DECIDE DETECT_LPATH      "LPATH"     '"$LIB_PATH_CANDIDATES" "all"'
ESOFT;  DECIDE DETECT_IPATH      "IPATH"     '"$INCLUDE_PATH_CANDIDATES" "all"'

ESOFT; DECIDE IF_NDEF_OR_IVAR WITH_LIBSSH2 1 && {
    ESOFT;  DECIDE DETECT_LIBRARY    "LIBSSH2"  'ssh2' && {
        DECIDE DEFINE_VAR       "WITH_LIBSSH2"      '"1"'
    } || {
        DECIDE DEFINE_VAR       "WITH_LIBSSH2"      '"0"'
    }
}

EHARD;  DECIDE DETECT_USER       "USER"
IN_VAR "USER" "root" && ! IN_VAR "WITH_USER" "root" && {
    NOTIFY "Warning" "Reseting USER variable. To force root, assign WITH_USER=root"
    DECIDE DEFINE_VAR     "USER"      '"nobody"'
}

CPATH="$CPATH $IPATH"
LDFLAGS="$LDFLAGS $LPATH"
LDLIBS="$LDLIBS $LIBSSL $LIBSSH2"
SET_VARS="PREFIX CC WITH_TCP_NODELAY WITH_LIBSSH2 CPATH LDFLAGS LDLIBS USER"
WRITE_VARS "$SET_VARS" "Makefile" "?" "Y"
EHARD; DECIDE CONFIG_FINISH     "STATE"     .configured
